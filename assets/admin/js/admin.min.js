$ = jQuery;
jQuery(document).ready(function () {

    /* id optimize chart found then load it  */
    if ($('#wc-optimize-chart').length > 0) {

        var chartData = JCIcalculateOptimizeRatio(0);

        var options = {
            series: [chartData.noneOptimizedPercentage, chartData.optimizedPercentage],
            colors: ['#60A5FA', '#3730A3'],
            labels: ['None Optimized', 'Optimized'],
            chart: {
                type: 'donut',
                width: '100%',
                events: {
                    selection: function (chartContext, { xaxis, yaxis }) {
                        return false
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    return val + "%"
                }
            },
            legend: {
                show: false
            },
            selection: {
                enabled: false,

            }
        };

        var chart = new ApexCharts(document.querySelector("#wc-optimize-chart"), options);
        chart.render().then();

    }

    $('body').on('submit', '#wc-webp-optimize', function (e) {
        e.preventDefault();
        var form_data = $(this).serialize();
        wc_webp_optimize(form_data, chart);
    });


    /* When user select the image compretion quality  */
    $('body').on('click', '.select-img-quality', function () {
        $('.select-img-quality').removeClass('active'); // remove active class from all the quality boxes
        $(this).addClass('active'); // add active class to current one
        $('.select-img-quality input[name="img_quality"]').prop('checked', false); // uncheck all
        $(this).find('input[name="img_quality"]').prop('checked', true); // checked selected
    });

});

function wc_webp_optimize(form_data, chart) {
    $('#wc-webp-optimize .wc-btn[type="submit"]').addClass('button--loading')
    $.ajax({
        type: "post",
        dataType: "json",
        url: wc_obj.ajax_url,
        data: {
            'action': 'wc_webp_optimize',
            'data': form_data
        },
        success: function (res) {
            if (res.success == true) {
                var newOptimized = res.optimize_img;
                var chartData = JCIcalculateOptimizeRatio(newOptimized);
                chart.updateSeries([chartData.noneOptimizedPercentage, chartData.optimizedPercentage])
                var alredyOptimized = $('#wc-optimize-chart').data('optimized') // already optimized images on page load
                var totalOptimized = parseFloat(alredyOptimized) + parseFloat(newOptimized);
                $('#wc-optimize-chart').data('optimized', totalOptimized)
                $('#wc-webp-optimize .wc-btn[type="submit"]').removeClass('button--loading')
                if (totalOptimized < parseFloat($('#wc-optimize-chart').data('total')) && parseFloat(newOptimized) != 0) {
                    wc_webp_optimize(form_data, chart); // there is still some images remains to optimize then trigger ajax again
                }
            }
        }
    });
}

function JCIcalculateOptimizeRatio(newOptmized = 0) {
    var canvas = $('#wc-optimize-chart');
    var totalImg = canvas.data('total'); // total images in media gallery

    var optimized = canvas.data('optimized') // optimized images in gallery
    var optimized = optimized + parseFloat(newOptmized); // less the new optimized images

    if (totalImg == '') {
        totalImg = 0
    }

    var optimizedPercentage = Math.round(optimized / totalImg * 100);

    if (isNaN(optimizedPercentage)) {
        optimizedPercentage = 100; // some time if there is not any images in media we need to set defult to optimize 100
    }

    var noneOptimizedPercentage = 100 - optimizedPercentage;

    var optimizeObj = {};
    optimizeObj['optimizedPercentage'] = optimizedPercentage;
    optimizeObj['noneOptimizedPercentage'] = noneOptimizedPercentage;
    return optimizeObj;
}